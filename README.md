create or replace PROCEDURE PROC_TSM_DRI_ALERT AS
    vMAXDATE   DATE;
    vSTDATE    DATE;
    vTODATE    DATE;
    vCount     NUMBER;
    vValue     NUMBER;
    vSql       varchar2(32667);
BEGIN
    SELECT MAX(DATE_TIME) INTO vMAXDATE FROM TSBSL.T_TSM_DRI_ALERT;

    IF vMAXDATE IS NULL THEN
        vMAXDATE :='01-JAN-2026';
    END IF;

    vSTDATE := vMAXDATE;
    vTODATE := trunc(SYSDATE);

    FOR k IN (SELECT SL_NO, PLANT, COLUMN_NAME, SOURCE_TABLE, DESTINATION_TABLE, LCL, UCL FROM TSBSL.T_TSM_DRI_ALERT_MASTER ORDER BY SL_NO)
    LOOP
        BEGIN
            SELECT COUNT(*) INTO vCount FROM TSBSL.T_TSM_DRI_ALERT WHERE DATE_TIME = vMAXDATE AND PLANT = k.PLANT AND COLUMN_NAME = k.COLUMN_NAME;
            IF vCount = 0 THEN
                INSERT INTO TSBSL.T_TSM_DRI_ALERT
                (DATE_TIME, PLANT, COLUMN_NAME, TOTAL_COUNT,
                 COUNT_BEYOND_LCL_MIN, COUNT_BEYOND_UCL_MAX)
                VALUES (vMAXDATE, k.PLANT, k.COLUMN_NAME, 0, 0, 0);
            END IF;

          -- LCL COUNT
        vSql :='SELECT '|| k.COLUMN_NAME || '  FROM ' || k.SOURCE_TABLE ||' WHERE Timestamp >= TO_DATE(''' || TO_CHAR(vSTDATE,'DD-MON-YYYY HH24:MI:SS') || ''',''DD-MON-YYYY HH24:MI:SS'')' ||' AND Timestamp <= TO_DATE(''' || TO_CHAR(vTODATE,'DD-MON-YYYY HH24:MI:SS') || ''',''DD-MON-YYYY HH24:MI:SS'')' ||' AND ' || k.COLUMN_NAME || ' < ' || k.LCL;
        EXECUTE IMMEDIATE vSql INTO vValue;
        IF vValue > 0 THEN
                EXECUTE IMMEDIATE 'UPDATE ' || k.DESTINATION_TABLE ||' SET COUNT_BEYOND_LCL_MIN = NVL(COUNT_BEYOND_LCL_MIN,0) + ' || vValue ||' WHERE DATE_TIME = TO_DATE(''' || TO_CHAR(vMAXDATE,'DD-MON-YYYY HH24:MI:SS') ||''',''DD-MON-YYYY HH24:MI:SS'')' ||' AND PLANT = ''' || k.PLANT || '''' ||' AND COLUMN_NAME = ''' || k.COLUMN_NAME || '''';
        END IF;

           -- UCL COUNT
        vSql :='SELECT '|| k.COLUMN_NAME || '  FROM ' || k.SOURCE_TABLE ||' WHERE Timestamp >= TO_DATE(''' || TO_CHAR(vMAXDATE,'DD-MON-YYYY HH24:MI:SS') || ''',''DD-MON-YYYY HH24:MI:SS'')' ||' AND DATE_TIME <= Timestamp(''' || TO_CHAR(vTODATE,'DD-MON-YYYY HH24:MI:SS') || ''',''DD-MON-YYYY HH24:MI:SS'')' ||' AND ' || k.COLUMN_NAME || ' > ' || k.UCL;
        EXECUTE IMMEDIATE vSql INTO vValue;
        IF vValue > 0 THEN
            EXECUTE IMMEDIATE 'UPDATE ' || k.DESTINATION_TABLE ||' SET COUNT_BEYOND_UCL_MAX = NVL(COUNT_BEYOND_UCL_MAX,0) + ' || vValue ||' WHERE DATE_TIME = TO_DATE(''' || TO_CHAR(vMAXDATE,'DD-MON-YYYY HH24:MI:SS') ||''',''DD-MON-YYYY HH24:MI:SS'')' ||' AND PLANT = ''' || k.PLANT || '''' ||' AND COLUMN_NAME = ''' || k.COLUMN_NAME || '''';        
        END IF;

    EXCEPTION
    WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('ERROR: ' || SQLERRM);
    END;
 END LOOP;
 COMMIT;
END PROC_TSM_DRI_ALERT;
