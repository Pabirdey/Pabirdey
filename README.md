Select a.Timestamp,ROUND(((((NVL(a.BASEMIX_CB_BF_SPEC_TODATE,0)+NVL(a.BASEMIX_CB_COKEOVEN1_SPEC_TODT,0)+NVL(a.BASEMIX_CB_COKEOVEN2_SPEC_TODT,0)+
NVL(a.BASEMIX_CB_BF2_SPEC_TODATE,0))+(NVL(a.CB_BF2_SPEC_TODATE,0)+NVL(a.CB_BF_SPEC_TODATE,0)+NVL(a.CB_COKE_OVEN2_SPEC_TODATE,0)+
NVL(a.CB_COKE_OVEN_SPEC_TODATE,0)) )*ROUND(Avg(decode(b.VM,0,Null,b.VM)),2))+((nvl(a.BASEMIX_CB_PURCH_SPEC_TODATE,0)+
nvl(a.CB_PURCH_SPEC_TODATE,0))*ROUND(Avg(decode(c.VM,0,Null,c.VM)),2))+( ( nvl(a.BASEMIX_ANTH_COAL_SPEC_TODATE,0)
+nvl(a.ANTH_COAL_SPEC_TODATE,0) )) *Avg(decode(d.VM,null,0,d.VM))) /
(NVL(a.BASEMIX_CB_BF_SPEC_TODATE,0)+NVL(a.BASEMIX_CB_COKEOVEN1_SPEC_TODT,0)+NVL(a.BASEMIX_CB_COKEOVEN2_SPEC_TODT,0)+NVL(a.BASEMIX_CB_BF2_SPEC_TODATE,0)
+(NVL(a.CB_BF2_SPEC_TODATE,0)+NVL(a.CB_BF_SPEC_TODATE,0)+NVL(a.CB_COKE_OVEN2_SPEC_TODATE,0)+NVL(a.CB_COKE_OVEN_SPEC_TODATE,0))
+nvl(a.BASEMIX_CB_PURCH_SPEC_TODATE,0)+nvl(a.CB_PURCH_SPEC_TODATE,0)+nvl(a.BASEMIX_ANTH_COAL_SPEC_TODATE,0)+NVL(a.CB_BF_SPEC_TODATE,0)
+NVL(a.CB_COKE_OVEN2_SPEC_TODATE,0)+NVL(a.CB_COKE_OVEN_SPEC_TODATE,0)),2) AS VM
From TSBSL.T_TSBSL_SN_PROD_DAILY a,tsbsl.t_tsbsl_ckbrz_shift b,tsbsl.t_tsbsl_ckbrz_shift c,tsbsl.t_tsbsl_ckbrz_shift d 
Where  trunc(a.Timestamp)=trunc(d.DATE_TIME(+)) AND trunc(a.Timestamp)=trunc(b.DATE_TIME(+)) 
AND trunc(a.Timestamp)=trunc(c.Date_Time(+))  AND  b.MAT_NAME='Fuel' AND b.source IN ('SP2','BBP')  
AND c.MAT_NAME='Fuel' AND c.source IN ('SP2','BBP')  
AND substr(c.SAMPLE_ID,instr(c.SAMPLE_ID,'/',1,1)+1,instr(c.SAMPLE_ID,'/',1,3)-instr(c.SAMPLE_ID,'/',1,2)-1) IN ('I','P')
AND substr(b.SAMPLE_ID,instr(b.SAMPLE_ID,'/',1,1)+1,instr(b.SAMPLE_ID,'/',1,3)-instr(b.SAMPLE_ID,'/',1,2)-1) IN ('I','P') AND 
a.SOURCE='SP2' AND a.Timestamp>=sysdate-100 and d.source(+) IN ('SP2','BBP') 
and upper(d.SAMPLE_ID(+)) LIKE '%COAL%'
GROUP BY trunc(b.DATE_TIME),
a.Timestamp,a.BASEMIX_CB_BF_SPEC_TODATE,a.BASEMIX_CB_COKEOVEN1_SPEC_TODT,a.BASEMIX_CB_COKEOVEN2_SPEC_TODT,
a.BASEMIX_CB_BF2_SPEC_TODATE,a.CB_BF2_SPEC_TODATE,a.CB_BF_SPEC_TODATE,a.CB_COKE_OVEN2_SPEC_TODATE,a.CB_COKE_OVEN_SPEC_TODATE,
a.BASEMIX_CB_PURCH_SPEC_TODATE,a.CB_PURCH_SPEC_TODATE,a.BASEMIX_ANTH_COAL_SPEC_TODATE,a.ANTH_COAL_SPEC_TODATE
Order by a.Timestamp desc
