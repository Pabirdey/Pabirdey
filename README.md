CREATE OR REPLACE PROCEDURE PROC_JODA_IOPP_PROCESS_DAILY
AS
    vMAXDATE DATE;
BEGIN
    EXECUTE IMMEDIATE
        'ALTER SESSION SET NLS_DATE_FORMAT = ''DD-MON-YYYY HH24:MI:SS''';

    -- Get last processed operational day
    SELECT NVL(MAX(TIMESTAMP), DATE '2025-11-01')
    INTO vMAXDATE
    FROM imtg.T_JODA_IOPP_PROCESS_DAILY;

    MERGE INTO imtg.T_JODA_IOPP_PROCESS_DAILY t
    USING (
        SELECT
            /* Operational day timestamp (06:00 basis) */
            TRUNC(p.TIMESTAMP - 6/24) + 6/24 AS TIMESTAMP,

            AVG(SCRUBBER_MASSFEED_RATE_1) SCRUBBER_MASSFEED_RATE_1,
            AVG(SCRUBBER_MASSFEED_RATE_2) SCRUBBER_MASSFEED_RATE_2,
            AVG(SCRUBBER_WATERFLOW_RATE_1) SCRUBBER_WATERFLOW_RATE_1,
            AVG(SCRUBBER_WATERFLOW_RATE_2) SCRUBBER_WATERFLOW_RATE_2,
            AVG(PRIMARY_SCREEN_PRDT_CONV_CV01) PRIMARY_SCREEN_PRDT_CONV_CV01,
            AVG(SEC_SCREEN_PRDT1_CONV_CV03) SEC_SCREEN_PRDT1_CONV_CV03,
            AVG(SEC_SCREEN_PRDT2_CONV_CV05) SEC_SCREEN_PRDT2_CONV_CV05,
            AVG(SCRUBBER_BUILDING_TANK_LVL_1) SCRUBBER_BUILDING_TANK_LVL_1,
            AVG(SCRUBBER_BUILDING_TANK_LVL_2) SCRUBBER_BUILDING_TANK_LVL_2,
            AVG(HC_TANK_LVL_1) HC_TANK_LVL_1,
            AVG(HC_TANK_LVL_3) HC_TANK_LVL_3,
            AVG(HC_TANK_LVL_2) HC_TANK_LVL_2,
            AVG(HC_TANK_LVL_4) HC_TANK_LVL_4,
            AVG(HC_DENSITY_1) HC_DENSITY_1,
            AVG(HC_FLOW_1) HC_FLOW_1,
            AVG(HC_PRESSURE_1) HC_PRESSURE_1,
            AVG(HC_DENSITY_2) HC_DENSITY_2,
            AVG(HC_FLOW_2) HC_FLOW_2,
            AVG(HC_PRESSURE_2) HC_PRESSURE_2,
            AVG(HFS_CONC_CONY_TPH) HFS_CONC_CONY_TPH,
            AVG(HFS_CONC_CONY_AMP) HFS_CONC_CONY_AMP,
            AVG(HRT_BED_MASS) HRT_BED_MASS,
            AVG(HRT_RAKE_TORQUE) HRT_RAKE_TORQUE,
            AVG(HRT_BED_LEVEL) HRT_BED_LEVEL,
            AVG(HRT_TURBIDITY_ANALYZER) HRT_TURBIDITY_ANALYZER,
            AVG(HRT_U_F_FLOWRATE) HRT_U_F_FLOWRATE,
            AVG(HRT_U_F_DENSITY) HRT_U_F_DENSITY,
            AVG(HRT_U_F_PRESSURE) HRT_U_F_PRESSURE,
            SUM(SLIME_TON_ONLINECAL) SLIME_TON_ONLINECAL

        FROM imtg.T_JODA_IOPP_PROCESS_HOURLY p
        WHERE p.TIMESTAMP >= vMAXDATE
        GROUP BY TRUNC(p.TIMESTAMP - 6/24) + 6/24
    ) s
    ON (t.TIMESTAMP = s.TIMESTAMP)

    WHEN MATCHED THEN
        UPDATE SET
            t.SCRUBBER_MASSFEED_RATE_1 = s.SCRUBBER_MASSFEED_RATE_1,
            t.SCRUBBER_MASSFEED_RATE_2 = s.SCRUBBER_MASSFEED_RATE_2,
            t.SCRUBBER_WATERFLOW_RATE_1 = s.SCRUBBER_WATERFLOW_RATE_1,
            t.SCRUBBER_WATERFLOW_RATE_2 = s.SCRUBBER_WATERFLOW_RATE_2,
            t.PRIMARY_SCREEN_PRDT_CONV_CV01 = s.PRIMARY_SCREEN_PRDT_CONV_CV01,
            t.SEC_SCREEN_PRDT1_CONV_CV03 = s.SEC_SCREEN_PRDT1_CONV_CV03,
            t.SEC_SCREEN_PRDT2_CONV_CV05 = s.SEC_SCREEN_PRDT2_CONV_CV05,
            t.SCRUBBER_BUILDING_TANK_LVL_1 = s.SCRUBBER_BUILDING_TANK_LVL_1,
            t.SCRUBBER_BUILDING_TANK_LVL_2 = s.SCRUBBER_BUILDING_TANK_LVL_2,
            t.HC_TANK_LVL_1 = s.HC_TANK_LVL_1,
            t.HC_TANK_LVL_3 = s.HC_TANK_LVL_3,
            t.HC_TANK_LVL_2 = s.HC_TANK_LVL_2,
            t.HC_TANK_LVL_4 = s.HC_TANK_LVL_4,
            t.HC_DENSITY_1 = s.HC_DENSITY_1,
            t.HC_FLOW_1 = s.HC_FLOW_1,
            t.HC_PRESSURE_1 = s.HC_PRESSURE_1,
            t.HC_DENSITY_2 = s.HC_DENSITY_2,
            t.HC_FLOW_2 = s.HC_FLOW_2,
            t.HC_PRESSURE_2 = s.HC_PRESSURE_2,
            t.HFS_CONC_CONY_TPH = s.HFS_CONC_CONY_TPH,
            t.HFS_CONC_CONY_AMP = s.HFS_CONC_CONY_AMP,
            t.HRT_BED_MASS = s.HRT_BED_MASS,
            t.HRT_RAKE_TORQUE = s.HRT_RAKE_TORQUE,
            t.HRT_BED_LEVEL = s.HRT_BED_LEVEL,
            t.HRT_TURBIDITY_ANALYZER = s.HRT_TURBIDITY_ANALYZER,
            t.HRT_U_F_FLOWRATE = s.HRT_U_F_FLOWRATE,
            t.HRT_U_F_DENSITY = s.HRT_U_F_DENSITY,
            t.HRT_U_F_PRESSURE = s.HRT_U_F_PRESSURE,
            t.SLIME_TON_ONLINECAL = s.SLIME_TON_ONLINECAL

    WHEN NOT MATCHED THEN
        INSERT VALUES s.*;

    COMMIT;
END PROC_JODA_IOPP_PROCESS_DAILY;
/