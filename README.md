CREATE OR REPLACE PROCEDURE PROC_JODA_IOPP_PROCESS_HOURLY
AS
    vMAXDATE DATE;
BEGIN
    EXECUTE IMMEDIATE
        'ALTER SESSION SET NLS_DATE_FORMAT = ''DD-MON-YYYY HH24:MI:SS''';

    -- Last processed hour
    SELECT NVL(MAX(TIMESTAMP), DATE '2025-11-01')
    INTO vMAXDATE
    FROM imtg.T_JODA_IOPP_PROCESS_HOURLY;

    MERGE INTO imtg.T_JODA_IOPP_PROCESS_HOURLY t
    USING (
        SELECT
            TRUNC(p.TIMESTAMP, 'HH24') AS TIMESTAMP,

            AVG(NULLIF(p.SCRUBBER_MASSFEED_RATE_1, 0)) SCRUBBER_MASSFEED_RATE_1,
            AVG(NULLIF(p.SCRUBBER_MASSFEED_RATE_2, 0)) SCRUBBER_MASSFEED_RATE_2,
            AVG(NULLIF(p.SCRUBBER_WATERFLOW_RATE_1, 0)) SCRUBBER_WATERFLOW_RATE_1,
            AVG(NULLIF(p.SCRUBBER_WATERFLOW_RATE_2, 0)) SCRUBBER_WATERFLOW_RATE_2,
            AVG(NULLIF(p.PRIMARY_SCREEN_PRDT_CONV_CV01, 0)) PRIMARY_SCREEN_PRDT_CONV_CV01,
            AVG(NULLIF(p.SEC_SCREEN_PRDT1_CONV_CV03, 0)) SEC_SCREEN_PRDT1_CONV_CV03,
            AVG(NULLIF(p.SEC_SCREEN_PRDT2_CONV_CV05, 0)) SEC_SCREEN_PRDT2_CONV_CV05,
            AVG(NULLIF(p.SCRUBBER_BUILDING_TANK_LVL_1, 0)) SCRUBBER_BUILDING_TANK_LVL_1,
            AVG(NULLIF(p.SCRUBBER_BUILDING_TANK_LVL_2, 0)) SCRUBBER_BUILDING_TANK_LVL_2,
            AVG(NULLIF(p.HC_TANK_LVL_1, 0)) HC_TANK_LVL_1,
            AVG(NULLIF(p.HC_TANK_LVL_3, 0)) HC_TANK_LVL_3,
            AVG(NULLIF(p.HC_TANK_LVL_2, 0)) HC_TANK_LVL_2,
            AVG(NULLIF(p.HC_TANK_LVL_4, 0)) HC_TANK_LVL_4,
            AVG(NULLIF(p.HC_DENSITY_1, 0)) HC_DENSITY_1,
            AVG(NULLIF(p.HC_FLOW_1, 0)) HC_FLOW_1,
            AVG(NULLIF(p.HC_PRESSURE_1, 0)) HC_PRESSURE_1,
            AVG(NULLIF(p.HC_DENSITY_2, 0)) HC_DENSITY_2,
            AVG(NULLIF(p.HC_FLOW_2, 0)) HC_FLOW_2,
            AVG(NULLIF(p.HC_PRESSURE_2, 0)) HC_PRESSURE_2,
            AVG(NULLIF(p.HFS_CONC_CONY_TPH, 0)) HFS_CONC_CONY_TPH,
            AVG(NULLIF(p.HFS_CONC_CONY_AMP, 0)) HFS_CONC_CONY_AMP,
            AVG(NULLIF(p.HRT_BED_MASS, 0)) HRT_BED_MASS,
            AVG(NULLIF(p.HRT_RAKE_TORQUE, 0)) HRT_RAKE_TORQUE,
            AVG(NULLIF(p.HRT_BED_LEVEL, 0)) HRT_BED_LEVEL,
            AVG(NULLIF(p.HRT_TURBIDITY_ANALYZER, 0)) HRT_TURBIDITY_ANALYZER,
            AVG(NULLIF(p.HRT_U_F_FLOWRATE, 0)) HRT_U_F_FLOWRATE,
            AVG(NULLIF(p.HRT_U_F_DENSITY, 0)) HRT_U_F_DENSITY,
            AVG(NULLIF(p.HRT_U_F_PRESSURE, 0)) HRT_U_F_PRESSURE,
            SUM(NULLIF(p.SLIME_TON_ONLINECAL, 0)) SLIME_TON_ONLINECAL

        FROM imtg.T_JODA_IOPP_PROCESS_RAW p
        WHERE p.TIMESTAMP >= vMAXDATE
        GROUP BY TRUNC(p.TIMESTAMP, 'HH24')
    ) s
    ON (t.TIMESTAMP = s.TIMESTAMP)

    WHEN MATCHED THEN
        UPDATE SET
            t.SCRUBBER_MASSFEED_RATE_1 = s.SCRUBBER_MASSFEED_RATE_1,
            t.SCRUBBER_MASSFEED_RATE_2 = s.SCRUBBER_MASSFEED_RATE_2,
            t.SCRUBBER_WATERFLOW_RATE_1 = s.SCRUBBER_WATERFLOW_RATE_1,
            t.SCRUBBER_WATERFLOW_RATE_2 = s.SCRUBBER_WATERFLOW_RATE_2,
            t.PRIMARY_SCREEN_PRDT_CONV_CV01 = s.PRIMARY_SCREEN_PRDT_CONV_CV01,
            t.SEC_SCREEN_PRDT1_CONV_CV03 = s.SEC_SCREEN_PRDT1_CONV_CV03,
            t.SEC_SCREEN_PRDT2_CONV_CV05 = s.SEC_SCREEN_PRDT2_CONV_CV05,
            t.SCRUBBER_BUILDING_TANK_LVL_1 = s.SCRUBBER_BUILDING_TANK_LVL_1,
            t.SCRUBBER_BUILDING_TANK_LVL_2 = s.SCRUBBER_BUILDING_TANK_LVL_2,
            t.HC_TANK_LVL_1 = s.HC_TANK_LVL_1,
            t.HC_TANK_LVL_3 = s.HC_TANK_LVL_3,
            t.HC_TANK_LVL_2 = s.HC_TANK_LVL_2,
            t.HC_TANK_LVL_4 = s.HC_TANK_LVL_4,
            t.HC_DENSITY_1 = s.HC_DENSITY_1,
            t.HC_FLOW_1 = s.HC_FLOW_1,
            t.HC_PRESSURE_1 = s.HC_PRESSURE_1,
            t.HC_DENSITY_2 = s.HC_DENSITY_2,
            t.HC_FLOW_2 = s.HC_FLOW_2,
            t.HC_PRESSURE_2 = s.HC_PRESSURE_2,
            t.HFS_CONC_CONY_TPH = s.HFS_CONC_CONY_TPH,
            t.HFS_CONC_CONY_AMP = s.HFS_CONC_CONY_AMP,
            t.HRT_BED_MASS = s.HRT_BED_MASS,
            t.HRT_RAKE_TORQUE = s.HRT_RAKE_TORQUE,
            t.HRT_BED_LEVEL = s.HRT_BED_LEVEL,
            t.HRT_TURBIDITY_ANALYZER = s.HRT_TURBIDITY_ANALYZER,
            t.HRT_U_F_FLOWRATE = s.HRT_U_F_FLOWRATE,
            t.HRT_U_F_DENSITY = s.HRT_U_F_DENSITY,
            t.HRT_U_F_PRESSURE = s.HRT_U_F_PRESSURE,
            t.SLIME_TON_ONLINECAL = s.SLIME_TON_ONLINECAL

    WHEN NOT MATCHED THEN
        INSERT VALUES s.*;

    COMMIT;
END PROC_JODA_IOPP_PROCESS_HOURLY;
/