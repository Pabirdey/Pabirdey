PROCEDURE PROC_JODA_IOPP_PROCESS_HOURLY
AS
vMAXDATE DATE;
Begin    
Execute immediate 'Alter session set nls_date_format=''DD-MON-YYYY HH24:MI:SS''';
    Select MAX(TIMESTAMP) into vMAXDATE From imtg.T_JODA_IOPP_PROCESS_HOURLY;
    IF vMAXDATE IS NULL THEN
        vMAXDATE:='01-NOV-2025';
    END IF;
    Merge INTO imtg.T_JODA_IOPP_PROCESS_HOURLY t
    Using (
            Select  TRUNC(TIMESTAMP,'HH24') TIMESTAMP,
                AVG(NULLIF(SCRUBBER_MASSFEED_RATE_1,0))SCRUBBER_MASSFEED_RATE_1,
                AVG(NULLIF(SCRUBBER_MASSFEED_RATE_2,0))SCRUBBER_MASSFEED_RATE_2,
                AVG(NULLIF(SCRUBBER_WATERFLOW_RATE_1,0))SCRUBBER_WATERFLOW_RATE_1,
                AVG(NULLIF(SCRUBBER_WATERFLOW_RATE_2,0))SCRUBBER_WATERFLOW_RATE_2,
                AVG(NULLIF(PRIMARY_SCREEN_PRDT_CONV_CV01,0))PRIMARY_SCREEN_PRDT_CONV_CV01,
                AVG(NULLIF(SEC_SCREEN_PRDT1_CONV_CV03,0))SEC_SCREEN_PRDT1_CONV_CV03,
                AVG(NULLIF(SEC_SCREEN_PRDT2_CONV_CV05,0))SEC_SCREEN_PRDT2_CONV_CV05,
                AVG(NULLIF(SCRUBBER_BUILDING_TANK_LVL_1,0))SCRUBBER_BUILDING_TANK_LVL_1,
                AVG(NULLIF(SCRUBBER_BUILDING_TANK_LVL_2,0))SCRUBBER_BUILDING_TANK_LVL_2,
                AVG(NULLIF(HC_TANK_LVL_1,0))HC_TANK_LVL_1,
                AVG(NULLIF(HC_TANK_LVL_3,0))HC_TANK_LVL_3,
                AVG(NULLIF(HC_TANK_LVL_2,0))HC_TANK_LVL_2,
                AVG(NULLIF(HC_TANK_LVL_4,0))HC_TANK_LVL_4,
                AVG(NULLIF(HC_DENSITY_1,0))HC_DENSITY_1,
                AVG(NULLIF(HC_FLOW_1,0))HC_FLOW_1,
                AVG(NULLIF(HC_PRESSURE_1,0))HC_PRESSURE_1,
                AVG(NULLIF(HC_DENSITY_2,0))HC_DENSITY_2,
                AVG(NULLIF(HC_FLOW_2,0))HC_FLOW_2,
                AVG(NULLIF(HC_PRESSURE_2,0))HC_PRESSURE_2,
                AVG(NULLIF(HFS_CONC_CONY_TPH,0))HFS_CONC_CONY_TPH,
                AVG(NULLIF(HFS_CONC_CONY_AMP,0))HFS_CONC_CONY_AMP,
                AVG(NULLIF(HRT_BED_MASS,0))HRT_BED_MASS,
                AVG(NULLIF(HRT_RAKE_TORQUE,0))HRT_RAKE_TORQUE,
                AVG(NULLIF(HRT_BED_LEVEL,0))HRT_BED_LEVEL,
                AVG(NULLIF(HRT_TURBIDITY_ANALYZER,0))HRT_TURBIDITY_ANALYZER,
                AVG(NULLIF(HRT_U_F_FLOWRATE,0))HRT_U_F_FLOWRATE,
                AVG(NULLIF(HRT_U_F_DENSITY,0))HRT_U_F_DENSITY,
                AVG(NULLIF(HRT_U_F_PRESSURE,0))HRT_U_F_PRESSURE,
                SUM(NULLIF(SLIME_TON_ONLINECAL,0))SLIME_TON_ONLINECAL
                From imtg.T_JODA_IOPP_PROCESS_RAW Where TIMESTAMP>=TIMESTAMP AND TIMESTAMP<TIMESTAMP+1/24
                Group by  TRUNC(TIMESTAMP,'HH24')  Order by TIMESTAMP
    )s
    ON (
        t.TIMESTAMP=s.TIMESTAMP       
        )
    When Matched Then
        Update Set         
            t.SCRUBBER_MASSFEED_RATE_1=s.SCRUBBER_MASSFEED_RATE_1,
            t.SCRUBBER_MASSFEED_RATE_2=s.SCRUBBER_MASSFEED_RATE_2,
            t.SCRUBBER_WATERFLOW_RATE_1=s.SCRUBBER_WATERFLOW_RATE_1,
            t.SCRUBBER_WATERFLOW_RATE_2=s.SCRUBBER_WATERFLOW_RATE_2,
            t.PRIMARY_SCREEN_PRDT_CONV_CV01=s.PRIMARY_SCREEN_PRDT_CONV_CV01,
            t.SEC_SCREEN_PRDT1_CONV_CV03=s.SEC_SCREEN_PRDT1_CONV_CV03,
            t.SEC_SCREEN_PRDT2_CONV_CV05=s.SEC_SCREEN_PRDT2_CONV_CV05,
            t.SCRUBBER_BUILDING_TANK_LVL_1=s.SCRUBBER_BUILDING_TANK_LVL_1,
            t.SCRUBBER_BUILDING_TANK_LVL_2=s.SCRUBBER_BUILDING_TANK_LVL_2,
            t.HC_TANK_LVL_1=s.HC_TANK_LVL_1,
            t.HC_TANK_LVL_3=s.HC_TANK_LVL_3,
            t.HC_TANK_LVL_2=s.HC_TANK_LVL_2,
            t.HC_TANK_LVL_4=s.HC_TANK_LVL_4,
            t.HC_DENSITY_1=s.HC_DENSITY_1,
            t.HC_FLOW_1=s.HC_FLOW_1,
            t.HC_PRESSURE_1=s.HC_PRESSURE_1,
            t.HC_DENSITY_2=s.HC_DENSITY_2,
            t.HC_FLOW_2=s.HC_FLOW_2,
            t.HC_PRESSURE_2=s.HC_PRESSURE_2,           
            t.HFS_CONC_CONY_TPH=s.HFS_CONC_CONY_TPH,
            t.HFS_CONC_CONY_AMP=s.HFS_CONC_CONY_AMP,
            t.HRT_BED_MASS=s.HRT_BED_MASS,
            t.HRT_RAKE_TORQUE=s.HRT_RAKE_TORQUE,
            t.HRT_BED_LEVEL=s.HRT_BED_LEVEL,
            t.HRT_TURBIDITY_ANALYZER=s.HRT_TURBIDITY_ANALYZER,
            t.HRT_U_F_FLOWRATE=s.HRT_U_F_FLOWRATE,
            t.HRT_U_F_DENSITY=s.HRT_U_F_DENSITY,
            t.HRT_U_F_PRESSURE=s.HRT_U_F_PRESSURE  ,
            t.SLIME_TON_ONLINECAL=s.SLIME_TON_ONLINECAL
    When Not Matched Then
    INSERT(TIMESTAMP,SCRUBBER_MASSFEED_RATE_1,SCRUBBER_MASSFEED_RATE_2,SCRUBBER_WATERFLOW_RATE_1,
    SCRUBBER_WATERFLOW_RATE_2,PRIMARY_SCREEN_PRDT_CONV_CV01,SEC_SCREEN_PRDT1_CONV_CV03,
    SEC_SCREEN_PRDT2_CONV_CV05,SCRUBBER_BUILDING_TANK_LVL_1,SCRUBBER_BUILDING_TANK_LVL_2,
    HC_TANK_LVL_1,HC_TANK_LVL_3,HC_TANK_LVL_2,HC_TANK_LVL_4,HC_DENSITY_1,HC_FLOW_1,
    HC_PRESSURE_1,HC_DENSITY_2,HC_FLOW_2,HC_PRESSURE_2,HFS_CONC_CONY_TPH,HFS_CONC_CONY_AMP,HRT_BED_MASS,HRT_RAKE_TORQUE,HRT_BED_LEVEL,
    HRT_TURBIDITY_ANALYZER,HRT_U_F_FLOWRATE,HRT_U_F_DENSITY,HRT_U_F_PRESSURE,SLIME_TON_ONLINECAL)
    VALUES(s.TIMESTAMP,s.SCRUBBER_MASSFEED_RATE_1,s.SCRUBBER_MASSFEED_RATE_2,s.SCRUBBER_WATERFLOW_RATE_1
    ,s.SCRUBBER_WATERFLOW_RATE_2,s.PRIMARY_SCREEN_PRDT_CONV_CV01,s.SEC_SCREEN_PRDT1_CONV_CV03,
    s.SEC_SCREEN_PRDT2_CONV_CV05,s.SCRUBBER_BUILDING_TANK_LVL_1,s.SCRUBBER_BUILDING_TANK_LVL_2,
    s.HC_TANK_LVL_1,s.HC_TANK_LVL_3,s.HC_TANK_LVL_2,s.HC_TANK_LVL_4,s.HC_DENSITY_1,s.HC_FLOW_1,
    s.HC_PRESSURE_1,s.HC_DENSITY_2,s.HC_FLOW_2,s.HC_PRESSURE_2,s.HFS_CONC_CONY_TPH,s.HFS_CONC_CONY_AMP,s.HRT_BED_MASS,s.HRT_RAKE_TORQUE,
    s.HRT_BED_LEVEL,s.HRT_TURBIDITY_ANALYZER,s.HRT_U_F_FLOWRATE,s.HRT_U_F_DENSITY,s.HRT_U_F_PRESSURE,s.SLIME_TON_ONLINECAL);
    Commit;                   
End PROC_JODA_IOPP_PROCESS_HOURLY;
