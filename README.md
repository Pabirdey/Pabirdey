 DECLARE
    vDate DATE;
BEGIN
    SELECT MAX(DATE_TIME) INTO vDate FROM KPO.T_KPO_SINTER_CHEMICAL Where SOURCE='SP1';

    IF vDate IS NULL THEN
        vDate := TO_DATE('20-DEC-2015', 'DD-MON-YYYY');
    END IF;

    MERGE INTO KPO.T_KPO_SINTER_CHEMICAL t
    USING (
        SELECT STR_TEST_DATE,
               Decode(STR_TEST_SHIFT,Null,'E',STR_TEST_SHIFT) STR_TEST_SHIFT ,
               STR_ELEMENT_CODE,
               STR_ANALYSIS_VALUE
        FROM CRMTXRF.SAMPLE_TEST_REPORT@MISPROD
        WHERE STR_ANALYSIS_VALUE <= 100
          AND STR_DEPT_CODE = 'L204'
          AND STR_TEST_GROUP_CODE = 'T342'
          AND STR_TEST_DATE > vDate
    ) s
    ON (
        t.DATE_TIME = s.STR_TEST_DATE
        AND t.SHIFT = s.STR_TEST_SHIFT
        AND t.SOURCE = 'SP1'
    )

    WHEN MATCHED THEN
        UPDATE SET
            t.CAO   = AVG(DECODE(s.STR_ELEMENT_CODE, 'E011', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.SIO2  = AVG(DECODE(s.STR_ELEMENT_CODE, 'E012', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.P     = AVG(DECODE(s.STR_ELEMENT_CODE, 'E026', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.MGO   = AVG(DECODE(s.STR_ELEMENT_CODE, 'E015', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.MNO   = AVG(DECODE(s.STR_ELEMENT_CODE, 'E016', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.AL2O3 = AVG(DECODE(s.STR_ELEMENT_CODE, 'E017', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.TIO2  = AVG(DECODE(s.STR_ELEMENT_CODE, 'E018', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.K2O   = AVG(DECODE(s.STR_ELEMENT_CODE, 'E020', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.FE    = AVG(DECODE(s.STR_ELEMENT_CODE, 'E042', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.FEO   = AVG(DECODE(s.STR_ELEMENT_CODE, 'E009', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.NA2O  = AVG(DECODE(s.STR_ELEMENT_CODE, 'E023', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.CL    = AVG(DECODE(s.STR_ELEMENT_CODE, 'E116', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.S     = AVG(DECODE(s.STR_ELEMENT_CODE, 'E014', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.CR2O3 = AVG(DECODE(s.STR_ELEMENT_CODE, 'E019', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.ZNO   = AVG(DECODE(s.STR_ELEMENT_CODE, 'D101', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            t.ZN    = AVG(DECODE(s.STR_ELEMENT_CODE, 'D101', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE * 0.8)))                       
    WHEN NOT MATCHED THEN
        INSERT (
            DATE_TIME, SHIFT, SOURCE, CAO, SIO2, P, MGO, MNO,
            AL2O3, TIO2, K2O, FE, FEO, NA2O, CL, S, CR2O3, ZNO, ZN
        )
        VALUES (
            s.STR_TEST_DATE,
            s.STR_TEST_SHIFT,
            'SP1',
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E011', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E012', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E026', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E015', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E016', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E017', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E018', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E020', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E042', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E009', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E023', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E116', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E014', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'E019', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'D101', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE))),
            AVG(DECODE(s.STR_ELEMENT_CODE, 'D101', DECODE(s.STR_ANALYSIS_VALUE, 0, NULL, s.STR_ANALYSIS_VALUE * 0.8)))
        );

    COMMIT;
END;
