SELECT 
    b.Timestamp AS Date_Month,
    'TSK_PELLET' AS PLANT,
    ROUND(a.ACTUAL_QUANTITY) AS NET_PROD,
    ROUND(b.NET_PRODUCTIVITY,1) AS NET_PRODUCTIVITY,
    ROUND(c.FE,1) AS FE,
    ROUND(c.CAO / NULLIF(c.SIO2,0),2) AS B2,
    ROUND(c.AL2O3,2) AS AL2O3,
    ROUND(c.P,3) AS Phos,
    ROUND(c.K2O,3) AS K2O,
    ROUND(d.AVG_CCS) AS CCS_CRMT,
    ROUND(c.PCT_TUM_6P3MM,1) AS TUMBLER_PLS_6P3_MM,
    ROUND(c.PLS_TUM_MIN_0P5MM,2) AS TUMBLER_MIN_0P5_MM,
    ROUND(AVG(e.RDI),2) AS RDI,
    ROUND(AVG(f.RI),1) AS RI,
    ROUND(AVG(g.SWELLING_INDEX),1) AS SWELLING_INDEX_CRMT,
    ROUND(NVL(b.NOA_ORE,0) + NVL(b.JODA_ORE,0) + NVL(b.CRUSHED_FINES,0) + NVL(b.NINL_ORE,0) + NVL(b.KHONDBOND_ORE,0)) AS TOT_IRON_ORE,
    ROUND(NVL(b.ANTHRACITE_FUEL,0) + NVL(b.NUT_COKE_FUEL,0) + NVL(b.COKE_BREEZE_FUEL,0),1) AS Solid_Fuel,
    ROUND(b.BENTONITE,2) AS BENTONITE,
    ROUND(
        b.NOA_ORE / DECODE(
            (NVL(b.NOA_ORE,0)+NVL(b.JODA_ORE,0)+NVL(b.CRUSHED_FINES,0)+NVL(b.NINL_ORE,0)+NVL(b.KHONDBOND_ORE,0)),
            0,NULL,
            (NVL(b.NOA_ORE,0)+NVL(b.JODA_ORE,0)+NVL(b.CRUSHED_FINES,0)+NVL(b.NINL_ORE,0)+NVL(b.KHONDBOND_ORE,0))
        ) * 100,1
    ) AS NOA_PERC,
    ROUND(
        b.JODA_ORE / DECODE(
            (NVL(b.NOA_ORE,0)+NVL(b.JODA_ORE,0)+NVL(b.CRUSHED_FINES,0)+NVL(b.NINL_ORE,0)+NVL(b.KHONDBOND_ORE,0)),
            0,NULL,
            (NVL(b.NOA_ORE,0)+NVL(b.JODA_ORE,0)+NVL(b.CRUSHED_FINES,0)+NVL(b.NINL_ORE,0)+NVL(b.KHONDBOND_ORE,0))
        ) * 100,1
    ) AS JODA_PERC,
    ROUND(
        AVG(
            (NVL(h.ENG_CONS_DRYER_1,0)+NVL(i.ENG_CONS_DRYER_2,0)) /
            DECODE(
                (NVL2(h.ENG_CONS_DRYER_1,1,0)+NVL2(i.ENG_CONS_DRYER_2,1,0)),
                0,NULL,
                (NVL2(h.ENG_CONS_DRYER_1,1,0)+NVL2(i.ENG_CONS_DRYER_2,1,0))
            )
        )
    ) AS AVG_ENG_COM
FROM 
    KPO.T_KPO_COST_DATA a
    LEFT JOIN KPO.T_KPO_PELLET_PROD_MONTHLY b ON b.Timestamp = TRUNC(a.DATE_Time,'MON')
    LEFT JOIN KPO.T_KPO_PELLET_QUALITY_MONTHLY c ON b.Timestamp = c.DATE_MONTH AND c.SOURCE='PRODUCT' AND c.PLANT='KPO-Pellet Plant'
    LEFT JOIN KPO.T_KPO_PELLET_CCS_MONTHLY d ON b.Timestamp = d.DATE_MONTH
    LEFT JOIN KPO.T_KPO_PELLET_RDI_DAILY e ON b.Timestamp = TRUNC(e.DATE_Time,'MON')
    LEFT JOIN KPO.T_KPO_PELLET_RI_DAILY f ON b.Timestamp = TRUNC(f.DATE_Time,'MON')
    LEFT JOIN KPO.T_KPO_PELLET_SWELLING_INDEX_DAILY g ON b.Timestamp = TRUNC(g.DATE_Time,'MON')
    LEFT JOIN KPO.T_KPO_PELLET_DRYING_GRIND_PROCESS_DAILY h ON TRUNC(b.Timestamp,'MON') = TRUNC(h.Timestamp,'MON') AND TRUNC(h.Timestamp,'MON') < TRUNC(SYSDATE,'MON')
    LEFT JOIN KPO.T_KPO_PELLET_DRYGRIND_STREAM2_DAILY i ON TRUNC(b.Timestamp,'MON') = TRUNC(i.Timestamp,'MON')
WHERE 
    b.Timestamp < SYSDATE
    AND b.Timestamp >= SYSDATE-365
GROUP BY 
    b.Timestamp,
    b.NET_PRODUCTIVITY,
    c.FE,
    c.CAO,
    c.SIO2,
    c.AL2O3,
    c.P,
    c.K2O,
    d.AVG_CCS,
    c.PCT_TUM_6P3MM,
    c.PLS_TUM_MIN_0P5MM,
    a.ACTUAL_QUANTITY,
    b.NOA_ORE,
    b.JODA_ORE,
    b.CRUSHED_FINES,
    b.NINL_ORE,
    b.KHONDBOND_ORE,
    b.BENTONITE,
    b.ANTHRACITE_FUEL,
    b.NUT_COKE_FUEL,
    b.COKE_BREEZE_FUEL
ORDER BY b.Timestamp;
