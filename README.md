PROCEDURE PROC_JODA_IOPP_PROCESS_RAW
AS
vMAXDATE DATE;
vST_DATE DATE;
Begin
    Execute immediate 'Alter session set nls_date_format=''DD-MON-YYYY HH24:MI''';
    Select MAX(TIMESTAMP) into vMAXDATE From imtg.T_JODA_IOPP_PROCESS_RAW;
    IF vMAXDATE IS NULL THEN
        vMAXDATE:='01-NOV-2025';
    END IF;
    vST_DATE:=vMAXDATE;
    Merge INTO imtg.T_JODA_IOPP_PROCESS_RAW t
    Using (
            Select MINUTE5(DATE_TIME)DATE_TIME,
                AVG(Decode(TAG_NAME,'07_WF001/TPH_PV',TAG_VALUE))SCRUBBER_MASSFEED_RATE_1,
                AVG(Decode(TAG_NAME,'07_WF002/TPH_PV',TAG_VALUE))SCRUBBER_MASSFEED_RATE_2,
                AVG(Decode(TAG_NAME,'07_ML01_FIC001/MV',TAG_VALUE))SCRUBBER_WATERFLOW_RATE_1,
                AVG(Decode(TAG_NAME,'07_ML02_FIC001/MV',TAG_VALUE))SCRUBBER_WATERFLOW_RATE_2,
                AVG(Decode(TAG_NAME,'06_WT_001/MV',TAG_VALUE))PRIMARY_SCREEN_PRDT_CONV_CV01,
                AVG(Decode(TAG_NAME,'08_WT_001/MV',TAG_VALUE))SEC_SCREEN_PRDT1_CONV_CV03,
                AVG(Decode(TAG_NAME,'08_WT_002/MV',TAG_VALUE))SEC_SCREEN_PRDT2_CONV_CV05,
                AVG(Decode(TAG_NAME,'08_TK01_LIT01/MV',TAG_VALUE))SCRUBBER_BUILDING_TANK_LVL_1,
                AVG(Decode(TAG_NAME,'08_TK02_LIT01/MV',TAG_VALUE))SCRUBBER_BUILDING_TANK_LVL_2,
                AVG(Decode(TAG_NAME,'13_TK01_LIT01/MV',TAG_VALUE))HC_TANK_LVL_1,
                AVG(Decode(TAG_NAME,'13_TK02_LIT01/MV',TAG_VALUE))HC_TANK_LVL_3,
                AVG(Decode(TAG_NAME,'13_TK03_LIT01/MV',TAG_VALUE))HC_TANK_LVL_2,
                AVG(Decode(TAG_NAME,'13_TK04_LIT01/MV',TAG_VALUE))HC_TANK_LVL_4,
                AVG(Decode(TAG_NAME,'13_SA01_DIT001/MV',TAG_VALUE))HC_DENSITY_1,
                AVG(Decode(TAG_NAME,'13_SA01_FIT001/MV',TAG_VALUE))HC_FLOW_1,
                AVG(Decode(TAG_NAME,'13_CY01_PIT01/MV',TAG_VALUE))HC_PRESSURE_1,
                AVG(Decode(TAG_NAME,'13_SA03_DIT001/MV',TAG_VALUE))HC_DENSITY_2,
                AVG(Decode(TAG_NAME,'13_SA03_FIT001/MV',TAG_VALUE))HC_FLOW_2,
                AVG(Decode(TAG_NAME,'13_CY02_PIT01/MV',TAG_VALUE))HC_PRESSURE_2,
                AVG(Decode(TAG_NAME,'13_WT_001/MV',TAG_VALUE))HFS_CONC_CONY_TPH,
                AVG(Decode(TAG_NAME,'13_CV01/CURR',TAG_VALUE))HFS_CONC_CONY_AMP,
                AVG(Decode(TAG_NAME,'26_TH01_ZT02/MV',TAG_VALUE))HRT_BED_MASS,
                AVG(Decode(TAG_NAME,'26_TH01_WT01/MV',TAG_VALUE))HRT_RAKE_TORQUE,
                AVG(Decode(TAG_NAME,'26_TH01_LIT01/MV',TAG_VALUE))HRT_BED_LEVEL,
                AVG(Decode(TAG_NAME,'26_TH01_AT01/MV',TAG_VALUE))HRT_TURBIDITY_ANALYZER,
                AVG(Decode(TAG_NAME,'26_PP17_FT01/MV',TAG_VALUE))HRT_U_F_FLOWRATE,
                AVG(Decode(TAG_NAME,'26_PP17_DT01/MV',TAG_VALUE))HRT_U_F_DENSITY,
                AVG(Decode(TAG_NAME,'26_PP17_PIT01/MV',TAG_VALUE))HRT_U_F_PRESSURE
                From imtg.T_JODA_IOPP_PROCESS_PROC_RAW Where DATE_TIME>vMAXDATE+1/288
                Group by MINUTE5(DATE_TIME) Order by MINUTE5(DATE_TIME) 
    )s
    ON (
        t.TIMESTAMP=s.DATE_TIME       
        )
    When Matched Then
        Update Set         
            t.SCRUBBER_MASSFEED_RATE_1=s.SCRUBBER_MASSFEED_RATE_1,
            t.SCRUBBER_MASSFEED_RATE_2=s.SCRUBBER_MASSFEED_RATE_2,
            t.SCRUBBER_WATERFLOW_RATE_1=s.SCRUBBER_WATERFLOW_RATE_1,
            t.SCRUBBER_WATERFLOW_RATE_2=s.SCRUBBER_WATERFLOW_RATE_2,
            t.PRIMARY_SCREEN_PRDT_CONV_CV01=s.PRIMARY_SCREEN_PRDT_CONV_CV01,
            t.SEC_SCREEN_PRDT1_CONV_CV03=s.SEC_SCREEN_PRDT1_CONV_CV03,
            t.SEC_SCREEN_PRDT2_CONV_CV05=s.SEC_SCREEN_PRDT2_CONV_CV05,
            t.SCRUBBER_BUILDING_TANK_LVL_1=s.SCRUBBER_BUILDING_TANK_LVL_1,
            t.SCRUBBER_BUILDING_TANK_LVL_2=s.SCRUBBER_BUILDING_TANK_LVL_2,
            t.HC_TANK_LVL_1=s.HC_TANK_LVL_1,
            t.HC_TANK_LVL_3=s.HC_TANK_LVL_3,
            t.HC_TANK_LVL_2=s.HC_TANK_LVL_2,
            t.HC_TANK_LVL_4=s.HC_TANK_LVL_4,
            t.HC_DENSITY_1=s.HC_DENSITY_1,
            t.HC_FLOW_1=s.HC_FLOW_1,
            t.HC_PRESSURE_1=s.HC_PRESSURE_1,
            t.HC_DENSITY_2=s.HC_DENSITY_2,
            t.HC_FLOW_2=s.HC_FLOW_2,
            t.HC_PRESSURE_2=s.HC_PRESSURE_2,           
            t.HFS_CONC_CONY_TPH=s.HFS_CONC_CONY_TPH,
            t.HFS_CONC_CONY_AMP=s.HFS_CONC_CONY_AMP,
            t.HRT_BED_MASS=s.HRT_BED_MASS,
            t.HRT_RAKE_TORQUE=s.HRT_RAKE_TORQUE,
            t.HRT_BED_LEVEL=s.HRT_BED_LEVEL,
            t.HRT_TURBIDITY_ANALYZER=s.HRT_TURBIDITY_ANALYZER,
            t.HRT_U_F_FLOWRATE=s.HRT_U_F_FLOWRATE,
            t.HRT_U_F_DENSITY=s.HRT_U_F_DENSITY,
            t.HRT_U_F_PRESSURE=s.HRT_U_F_PRESSURE           
    When Not Matched Then
    INSERT(TIMESTAMP,SCRUBBER_MASSFEED_RATE_1,SCRUBBER_MASSFEED_RATE_2,SCRUBBER_WATERFLOW_RATE_1,
    SCRUBBER_WATERFLOW_RATE_2,PRIMARY_SCREEN_PRDT_CONV_CV01,SEC_SCREEN_PRDT1_CONV_CV03,
    SEC_SCREEN_PRDT2_CONV_CV05,SCRUBBER_BUILDING_TANK_LVL_1,SCRUBBER_BUILDING_TANK_LVL_2,
    HC_TANK_LVL_1,HC_TANK_LVL_3,HC_TANK_LVL_2,HC_TANK_LVL_4,HC_DENSITY_1,HC_FLOW_1,
    HC_PRESSURE_1,HC_DENSITY_2,HC_FLOW_2,HC_PRESSURE_2,HFS_CONC_CONY_TPH,HFS_CONC_CONY_AMP,HRT_BED_MASS,HRT_RAKE_TORQUE,HRT_BED_LEVEL,
    HRT_TURBIDITY_ANALYZER,HRT_U_F_FLOWRATE,HRT_U_F_DENSITY,HRT_U_F_PRESSURE)
    VALUES(s.DATE_TIME,s.SCRUBBER_MASSFEED_RATE_1,s.SCRUBBER_MASSFEED_RATE_2,s.SCRUBBER_WATERFLOW_RATE_1
    ,s.SCRUBBER_WATERFLOW_RATE_2,s.PRIMARY_SCREEN_PRDT_CONV_CV01,s.SEC_SCREEN_PRDT1_CONV_CV03,
    s.SEC_SCREEN_PRDT2_CONV_CV05,s.SCRUBBER_BUILDING_TANK_LVL_1,s.SCRUBBER_BUILDING_TANK_LVL_2,
    s.HC_TANK_LVL_1,s.HC_TANK_LVL_3,s.HC_TANK_LVL_2,s.HC_TANK_LVL_4,s.HC_DENSITY_1,s.HC_FLOW_1,
    s.HC_PRESSURE_1,s.HC_DENSITY_2,s.HC_FLOW_2,s.HC_PRESSURE_2,s.HFS_CONC_CONY_TPH,s.HFS_CONC_CONY_AMP,s.HRT_BED_MASS,s.HRT_RAKE_TORQUE,
    s.HRT_BED_LEVEL,s.HRT_TURBIDITY_ANALYZER,s.HRT_U_F_FLOWRATE,s.HRT_U_F_DENSITY,s.HRT_U_F_PRESSURE);
    Commit;    
    /*********************************************ADDED BY PABIR ON DATE:-29-JAN-2026 AS PER REQUEST PRATEEK SINGH/GAURAV SIR.************************/
    Begin
        For k in (Select Timestamp,HRT_U_F_FLOWRATE,HRT_U_F_DENSITY From imtg.T_JODA_IOPP_PROCESS_RAW Where Timestamp>=vST_DATE-5/24 Order by Timestamp)
                    Loop
                        Begin
                            Update imtg.T_JODA_IOPP_PROCESS_RAW SET 
                            Slime_ton_OnlineCal=(k.HRT_U_F_FLOWRATE * k.HRT_U_F_DENSITY )/12 * (100 *(1-1/Decode(k.HRT_U_F_DENSITY,0,NULL,k.HRT_U_F_DENSITY))/(1-1/3.6))/100
                            Where Timestamp=k.Timestamp;
                        Exception
                        When Others Then 
                        DBMS_OUTPUT.PUT_LINE(SQLERRM);                        
                        End;
                    End Loop;                          
                   Commit;
                   Exception
    When Others Then 
    DBMS_OUTPUT.PUT_LINE(SQLERRM);
    END;
    
End PROC_JODA_IOPP_PROCESS_RAW;
